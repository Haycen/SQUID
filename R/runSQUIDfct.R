#' run SQUID without graphical user interface
#'
#' @description          simulates a world inhabited by individuals whose phenotypes are generated by a user-defined 
#'                       phenotypic equation and then samples from this world according to a user-defined sampling design.
#' 
#' @param input          list of the model input paramters (see details).
#' @param module         character of the module name. This argument is only used by SQUID app.
#' @param plot           logical value. If \code{TRUE}, \code{runSQUIDfct} includes the plots of the simulation results into the output list.
#' @param X_previsualization character of the environment name. This argument is only used by SQUID app.
#'
#' @return               list that includes a data.frame of the full data generated and a data.frame 
#'                       of the sampled data and plots of the results if \code{plot} is \code{TRUE} (see details).
#'   
#' @details 
#' \tabular{lll}{
#'  \strong{Parameter name} \tab \strong{Default value} \tab \strong{Description} \cr
#'  \code{Tmax} \tab 1 \tab Positive integer of the duration of the simulation (number of time steps). \cr
#'  \code{NP}   \tab 1 \tab Positive integer of the number of replicated populations. 
#'                          The replicated populations are generated independently 
#'                          using the same simulation design that has been initially 
#'                          inputted by the user. Note that data from different 
#'                          populations will be saved in the same output file that
#'                          you could later use to run statistical analyses. \cr
#'  \code{NI}   \tab 1 \tab Positive integer of the number of individuals in each sampled population. 
#'                          \code{NI} must be divisible by the number of higher-level groups (\code{NG}). \cr
#'  \code{NT}   \tab 1 \tab Positive integer of the number of traits for each individual. SQUID allows a maximum of 2 traits. \cr
#'  \code{NG}   \tab 1 \tab Positive integer of the number of higher-level groups. \code{NG} must be lower than the number of individuals. \cr
#'  
#'  \code{X1_state}     \tab \code{FALSE} \tab Logical value. If \code{TRUE}, 
#'                                             an environmental effect x1 will be added to the model equation.  \cr
#'  \code{X1_sto_state} \tab \code{FALSE} \tab Logical value. If \code{TRUE},
#'                                             a stochastic environmental effect will be added to the environmental effect x1.
#'                                             The stochastic environmental effect values have a normal distribution around 0 and a variance of \code{X1_sto_V}\cr
#'  \code{X1_sto_shared}\tab \code{TRUE}  \tab Logical avlue. If \code{TRUE}, 
#'                                             the stochastic environmental effect included in the environmental effect x1 
#'                                             will be shared between individuals. 
#'                                             If \code{FALSE}, each individual will experience a different stochastic 
#'                                             environmental effect within the environmental effect x1 
#'                                             (i.e. a new stochastic environmental effect is generated for each individual).\cr
#'  \code{X1_sto_V}     \tab 1            \tab Numeric value of the variance used to generate a normal distributed 
#'                                             stochastic environmental effect within the environmental effect x1.\cr
#'  
#'  \code{X1_sto_autocor_state} \tab \code{FALSE} \tab Logical value.  If \code{TRUE}, an autocorrelation effect will be 
#'                                                     added to the stochastic environemental effect within the environmental effect x1. \cr
#'  \code{X1_sto_corr}          \tab 0            \tab Numeric value. The correlation value ranging from 0 to 1 
#'                                                     that characterizes the magnitude of the temporal autocorrelation. \cr
#'  
#'  \code{X1_lin_state}     \tab \code{FALSE} \tab Logical value. If \code{TRUE}, a linear trend will be added the environmental effect x1. \cr
#'  \code{X1_lin_shared}    \tab \code{TRUE}  \tab Logical avlue. If \code{TRUE}, 
#'                                             the linear trend included in the environmental effect x1 
#'                                             will be shared between individuals. 
#'                                             If \code{FALSE}, each individual will experience a different linear trend 
#'                                             within the environmental effect x1. 
#'                                             A new linear trend is generated for each individual by varying the intercept 
#'                                             and the slope of the linear equation fowlling a normal distribution where 
#'                                             the mean is the intercept and the slope value itself and the variance is \code{X1_lin_V}. \cr
#'  \code{X1_lin_intercept} \tab 0            \tab Numeric value of the intercept of the linear trend included into the environmental effect x1. \cr
#'  \code{X1_lin_slope}     \tab 1            \tab Numeric value of the slope of the linear trend included into the environmental effect x1. \cr
#'  \code{X1_lin_V}         \tab 1            \tab Numeric value of the variance used to generate different (unshared) linear trend effect for each individual within the environmnetal effect x1. \cr
#'  
#'  \code{X1_cyc_state}     \tab \code{FALSE} \tab Logical value. If \code{TRUE}, a cyclic trend will be added the environmental effect x1. \cr
#'  \code{X1_cyc_shared}    \tab \code{TRUE}  \tab Logical avlue. If \code{TRUE}, 
#'                                                 the cyclic trend included in the environmental effect x1 
#'                                                 will be shared between individuals. 
#'                                                 If \code{FALSE}, each individual will experience a different cyclic trend 
#'                                                 within the environmental effect x1.
#'                                                 A new cyclic trend is generated for each individual by varying the amplitude, 
#'                                                 the period, the horizontal shif and the vertical shift 
#'                                                 of the cyclic equation following a normal distribution where 
#'                                                 the mean is the parameter value itself and the variance is \code{X1_cyc_V}. \cr
#'  \code{X1_cyc_amplitude} \tab 10           \tab Positive numeric value of the amplitude of the cyclic trend included into the environmental effect x1. \cr
#'  \code{X1_cyc_period}    \tab 10           \tab Positive numeric value of the period of the cyclic trend included into the environmental effect x1. \cr
#'  \code{X1_cyc_Hshift}    \tab 0            \tab Positive numeric value of the horizontal shift of the cyclic trend included into the environmental effect x1. \cr
#'  \code{X1_cyc_Vshift}    \tab 0            \tab Positive numeric value of the vertical shift of the cyclic trend included into the environmental effect x1. \cr
#'  \code{X1_cyc_V}         \tab 0            \tab Numeric value of the variance used to generate different (unshared) cycluc trend effect for each individual within the environmnetal effect x1. \cr
#'  
#'  
#'  
#'  
#'  \code{X2_state}     \tab \code{FALSE} \tab Logical value. If \code{TRUE}, 
#'                                             an environmental effect x2 will be added to the model equation.  \cr
#'  \code{X2_sto_state} \tab \code{FALSE} \tab Logical value. If \code{TRUE},
#'                                             a stochastic environmental effect will be added to the environmental effect x2.
#'                                             The stochastic environmental effect values have a normal distribution around 0 and a variance of \code{X2_sto_V}\cr
#'  \code{X2_sto_shared}\tab \code{TRUE}  \tab Logical avlue. If \code{TRUE}, 
#'                                             the stochastic environmental effect included in the environmental effect x2 
#'                                             will be shared between individuals. 
#'                                             If \code{FALSE}, each individual will experience a different stochastic 
#'                                             environmental effect within the environmental effect x2 
#'                                             (i.e. a new stochastic environmental effect is generated for each individual).\cr
#'  \code{X2_sto_V}     \tab 1            \tab Numeric value of the variance used to generate a normal distributed 
#'                                             stochastic environmental effect within the environmental effect x2.\cr
#'  
#'  \code{X2_sto_autocor_state} \tab \code{FALSE} \tab Logical value.  If \code{TRUE}, an autocorrelation effect will be 
#'                                                     added to the stochastic environemental effect within the environmental effect x2. \cr
#'  \code{X2_sto_corr}          \tab 0            \tab Numeric value. The correlation value ranging from 0 to 1 
#'                                                     that characterizes the magnitude of the temporal autocorrelation. \cr
#'  
#'  \code{X2_lin_state}     \tab \code{FALSE} \tab Logical value. If \code{TRUE}, a linear trend will be added the environmental effect x2. \cr
#'  \code{X2_lin_shared}    \tab \code{TRUE}  \tab Logical avlue. If \code{TRUE}, 
#'                                             the linear trend included in the environmental effect x2 
#'                                             will be shared between individuals. 
#'                                             If \code{FALSE}, each individual will experience a different linear trend 
#'                                             within the environmental effect x2. 
#'                                             A new linear trend is generated for each individual by varying the intercept 
#'                                             and the slope of the linear equation fowlling a normal distribution where 
#'                                             the mean is the intercept and the slope value itself and the variance is \code{X2_lin_V}. \cr
#'  \code{X2_lin_intercept} \tab 0            \tab Numeric value of the intercept of the linear trend included into the environmental effect x2. \cr
#'  \code{X2_lin_slope}     \tab 1            \tab Numeric value of the slope of the linear trend included into the environmental effect x2. \cr
#'  \code{X2_lin_V}         \tab 1            \tab Numeric value of the variance used to generate different (unshared) linear trend effect for each individual within the environmnetal effect x2. \cr
#'  
#'  \code{X2_cyc_state}     \tab \code{FALSE} \tab Logical value. If \code{TRUE}, a cyclic trend will be added the environmental effect x2. \cr
#'  \code{X2_cyc_shared}    \tab \code{TRUE}  \tab Logical avlue. If \code{TRUE}, 
#'                                                 the cyclic trend included in the environmental effect x2 
#'                                                 will be shared between individuals. 
#'                                                 If \code{FALSE}, each individual will experience a different cyclic trend 
#'                                                 within the environmental effect x2.
#'                                                 A new cyclic trend is generated for each individual by varying the amplitude, 
#'                                                 the period, the horizontal shif and the vertical shift 
#'                                                 of the cyclic equation following a normal distribution where 
#'                                                 the mean is the parameter value itself and the variance is \code{X2_cyc_V}. \cr
#'  \code{X2_cyc_amplitude} \tab 10           \tab Positive numeric value of the amplitude of the cyclic trend included into the environmental effect x2. \cr
#'  \code{X2_cyc_period}    \tab 10           \tab Positive numeric value of the period of the cyclic trend included into the environmental effect x2. \cr
#'  \code{X2_cyc_Hshift}    \tab 0            \tab Positive numeric value of the horizontal shift of the cyclic trend included into the environmental effect x2. \cr
#'  \code{X2_cyc_Vshift}    \tab 0            \tab Positive numeric value of the vertical shift of the cyclic trend included into the environmental effect x2. \cr
#'  \code{X2_cyc_V}         \tab 0            \tab Numeric value of the variance used to generate different (unshared) cycluc trend effect for each individual within the environmnetal effect x2. \cr
#'  
#'  \code{X_Interaction}    \tab \code{FALSE} \tab Logical value. If \code{TRUE}, 
#'                                                 the environmental effect x1*x2 representing the interaction between the environmental 
#'                                                 effect x1 and the environmental effect x2 will added to the model equation. \cr
#'  
#'  \code{B}          \tab              \tab  \cr
#'  \code{Vind}       \tab              \tab  \cr
#'  \code{Ve}         \tab  0           \tab  Positive numeric value of the measurement error variance. \cr
#'  \code{VG}         \tab  0           \tab  Positive numeric value of the high-level grouping variance. \cr
#'  
#'  \code{NR}         \tab  1           \tab  Positive integer value of the number of records sampled in average per individual. \cr
#'  \code{Vhsi}       \tab  0           \tab  Numeric value between 0 and 0.95 of the among-individual variance in timing of sampling. \cr
#'  
#'  \code{NR_ind}     \tab  \code{TRUE} \tab  Logical value. If \code{TRUE}, individuals will be sampled the same number of times. \cr
#'  \code{NR_trait}   \tab  \code{TRUE} \tab  Logical value. If \code{TRUE}, traits within individuals will be sampled the same number of times. \cr
#'  \code{ST_ind}     \tab  \code{TRUE} \tab  Logical value. If \code{TRUE}, individuals will be sampled at the same time.\cr
#'  \code{ST_trait}   \tab  \code{TRUE} \tab  Logical value. If \code{TRUE}, traits within individuals will be sampled at the same times. \cr
#'  
#'  \strong{Parameter name} \tab \strong{Default value} \tab \strong{Description}
#' }
#'                                                               
#' @import data.table
#' @export
#' 
runSQUIDfct <- function(input=list(), module=NULL, plot=FALSE, X_previsualization=NULL){ 
  
  # Main function of the full model that simulates individual phenotypes over time
  # and then samples within those phenotypes according to specific sampling design
  #
  # Args:
  #   input: list contains all the inputs used to run the model 
  #          (for more details see setEnvironments and setVariables functions).
  #   module: name of the module.
  
  # Returns:
  #   Return a list with:
  #     full_Data   : continous phenotypic data (raw data)
  #     sampled_Data: sampled phenotypic data
  #     myPlot      : plots of the simulation results
  
  ##############################################################
  #################### INPUT VARIABLES  ########################
  ##############################################################  
  
  # Set seperator character
  sep <- ifelse(is.null(module), "", "_")
  
  # Set up environmental variables
  environments <- setEnvironments(input, module, sep)
  
  # Set up other variables
  variables    <- setVariables(input, module, environments, sep)
  
  Mu        <- variables$Mu
  N         <- variables$N
  B         <- variables$B
  V         <- variables$V
  Time      <- variables$Time
  variables <- variables$Variables
  
  if(is.null(X_previsualization)){
    
    # Initialize output
    output <- list()
    
    #######################################################################################
    ## Generate my phenotype traits
    output[["full_Data"]]    <- getFullData(Mu, N, B, r, V, Time, variables, environments)
    
    ####################################################################################### 
    ## Get Sampling data  
    output[["sampled_Data"]] <- getSampledData(N, Time, output[["full_Data"]])
    
    #######################################################################################
    ## Display results
    if(plot) 
      output[["myPlot"]]     <- displayResults(N, Time, output[["full_Data"]], output[["sampled_Data"]])
    
    #######################################################################################
    
  }else{
    
    if(X_previsualization %in% c("X1", "X2")){
      ### Generate environment for previsualization
      X <- getEnvironment(environments[[X_previsualization]], N, TRUE)
      
      myData   <- data.frame("envData"  = X, 
                             "x"        = rep(1:N$NS, N$NI),
                             "colour"   = as.factor(rep(1:N$NI, each = N$NS)))
      
      output   <- ggplot2::ggplot(myData, ggplot2::aes(y=envData, x=x, colour=colour)) +
                                  ggplot2::geom_point() +
                                  ggplot2::xlab("Time") +
                                  ggplot2::ylab("Environment") + 
                                  ggplot2::theme(legend.position="none")
    }else{
      stop("X_previsualization is not a valid environment tag.")
    }
  }
  
  return(output)
  
}